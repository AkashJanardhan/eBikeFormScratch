<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>E-Bike Image Upload</title>
</head>
<body>

<h2>Upload E-Bike Image</h2>

<form id="uploadForm">
    <input type="file" id="imageFile" name="file">
    <button type="submit">Upload Image</button>
</form>

<script>
// Assuming you have an API endpoint from API Gateway
const apiEndpoint = 'https://4jyzsa7chd.execute-api.us-west-2.amazonaws.com/dev';

document.getElementById('uploadForm').onsubmit = async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('imageFile');
    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];

        try {
            // Fetching a presigned URL from your API, including the filename in the request
            const response = await fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ filename: file.name }) // Assuming you're sending the file name to your API
            });

            if (response.ok) {
                const responseBody = await response.json();
                
                // The API response's 'body' is a JSON-encoded string, so parse it as JSON
                const data = JSON.parse(responseBody.body);

                const presignedUrl = data.url; // Extracting the presigned URL from the parsed data
                const objectName = data.objectName; // Extracting the object name from the parsed data
                
                // Log the presigned URL and object name to the console
                console.log('Presigned URL:', presignedUrl);
                console.log('Object Name:', objectName);

                // Use the presigned URL to upload the file directly to S3
                const uploadResponse = await fetch(presignedUrl, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type // Use the file's actual MIME type
                    },
                    body: file
                });

                if (uploadResponse.ok) {
                    alert('Image uploaded successfully.\n' + `Stored as: ${objectName}`);
                } else {
                    alert('Failed to upload the image.');
                }
            } else {
                // Handle HTTP errors
                console.error('HTTP Error:', response.statusText);
                alert('Failed to fetch presigned URL.');
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            alert('Error uploading the image.');
        }
    } else {
        alert('Please select a file to upload.');
    }
};

</script>

</body>
</html>
